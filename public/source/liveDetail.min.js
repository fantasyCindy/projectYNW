"use strict";var info=function(){var t,e,n,i=function(){e.click(function(){return ynIsLogin?+ynTeacherId==+room_teacherid?void layer.msg("不能关注自己啊"):$(this).attr("class").indexOf("true")!=-1?void yndata.cancelCare(ynUserId,room_teacherid).done(function(){e.removeClass("true").text("关注")}):void yndata.addCare(ynUserId,room_teacherid).done(function(){e.addClass("true").text("取消关注")}):void yn.login.render()});var t=ynmodule.askWindow();t.init(),$(".askWin-trigger").click(function(){if(ynTeacherId==room_teacherid)return void layer.msg("扪心自问");var e=room_teacherid,n=$("#teacher-nickName").text();t.render(),t.add(e,n,{reset:!0})})};return{init:function(){t=$("#live-info"),e=$("#live-info .care"),n=$("#live-info .ask"),i()}}}(),menu=function(){function t(){var t=-1,n={liveDetail:0,liveDetailLive:1,liveDetailAnswer:2,liveDetailOpinion:3,liveDetailRefer:5},i=location.href.match(/(\w+)\.htm/);i&&(t=n[i[1]]),e.find(".item").eq(t).addClass("select")}var e;return{init:function(){e=$(".liveDetail-menu"),t()}}}(),subject=function(){var t,e,n;return{init:function(){t=$(".living-subject"),e=t.find(".history"),edit=t.find(".fa-edit"),n=$("#living-subject-value"),e.on("click",function(){$("#liveDetail").hide(),liveHistory.render()}),t.on("click",".fa-edit",function(){modifyWin.render(n.text()),modifyWin.delegate.done=function(t){n.text(t)}})},showEidt:function(){edit.show()}}}(),modifyWin=function(){var t,e,n,i,o;return{init:function(a){t=a;var r=this;n=$("#modify-subject-container"),e=$("#modify-subject"),i=e.find("textarea"),c=e.find(".submit"),o=e.find(".wordCountValue"),e.on("click",".close",function(){n.hide(),i.val("")}),yn.wordCount(i,{indicate:o,limit:25}),c.click(_.debounce(function(){return i.val()?void c():void layer.msg("主题不能为空")},2e3,{leading:!0,trailing:!1}));var c=function(){var e=i.val();$.post("/center/editPeriodical.htm",{periodicalid:t,todaysubject:e},function(t){return 0===t?void lalyer.alert("参数为空"):void("success"==t&&(layer.msg("修改成功"),n.hide(),r.delegate.done(e)))})}},render:function(t){n.show(),yn.centerBox(e),t&&i.val(t).trigger("keyup")},delegate:{done:function(){}}}}(),living=function(){function t(){a.on("click","img",function(){yn.zoomImage($(this))}),o.on("click",".loadMore",function(){var t=$(this);r=$(this).next().data("id"),e(function(e){var i=n(e.rows);t.after(template(d,i)),e.hasMore||t.remove()})}),o.on("click",".yn-icon-sound",function(){$(this).toggleClass("stop"),living.enableAudio=!living.enableAudio}),o.on("click",".delete",function(){if(+room_teacherid==ynTeacherId){var t=$(this),e=$(this).parents(".live-item-2");layer.confirm("确定要删除吗?",function(n){var i=t.data("id");$.post("/html/broadcasting/delBroadcasting.htm",{id:i},function(t){"success"==t?(e.remove(),layer.close(n)):layer.msg("dderror : "+t)})})}})}function e(t){$.getJSON("/html/queryLiveInfo.htm",{id:r,periodicalid:i,pageSize:c},function(e){e.hasMore=+e.total-c>0,t(e)})}function n(t){return t=t.reverse(),_.map(t,function(t){return t.content=yn.codeFormat(t.content),t.deleteStyle=String(+room_teacherid==+ynTeacherId),t})}var i,o,a,r="",c=20,l=!1,d="live-template-2";return{enableAudio:!0,init:function(e){i=e,o=$("#live"),a=o.find(".items"),living.setting.init(),t()},render:function(){$("#liveDetail").show(),e(function(t){console.log("直播信息",t);var e=n(t.rows);return+t.total<1?(l=!0,void a.html(ynconfig.none({margin:250}))):(a.html(template(d,e)),t.hasMore&&a.prepend(ynconfig.more()),void a.scrollTop(3e5))})},onSocket:function(t){l&&(a.find(".nothing").remove(),live.nothing=!1),t.pubtimeString=t.showTimeStr,t.teacherName=t.nickName,t.id=t.dataId,a.append(template(d,[t])),a.scrollTop(1e4),living.enableAudio&&audio.play()},onTimer:function(){e(function(t){var e=n(t.rows);a.html(template("live-template",e))})}}}();living.setting=function(){var t,e,n,i=function(){n.click(function(){$(this).parent().find(".select").removeClass("select"),$(this).addClass("select");var e=$(this).data("size");t.find(".items").attr("id","items-"+e)})};return{init:function(){t=$("#live"),e=t.find(".settting"),n=e.find(".font-size-item"),i()}}}();var pubLive=function(){var t,e,n,i,o,a=function(){i.on("click",_.debounce(function(){r()},2e3,{leading:!0,trailing:!1}))},r=function(){var t=e.getContent();return t?void yndata.publishLiveContent(o,t).done(function(){e.setContent("")}):void layer.msg("发布内容不能为空")};return{init:function(r){o=r,t=$("#pubEditer"),n=$(".insertStockCode"),i=t.find(".submit"),e=UE.getEditor("ueditContainer",{toolbars:[["bold","indent","snapscreen","underline","pasteplain","horizontal","removeformat","fontsize","simpleupload","insertimage","justifyleft","justifycenter","justifyjustify","fullscreen","imagecenter","lineheight"]],initialFrameHeight:250,elementPathEnabled:!1,wordCount:!1,enableContextMenu:!1,enableAutoSave:!1,pasteplain:!0,autotypeset:{removeClass:!0,clearFontSize:!0,removeEmptyline:!0,removeEmptyNode:!1,autotypeset:!0,indentValue:"2em"}}),yn.showStockList(n,{listLen:4,onSelect:function(t){n.val(""),e.execCommand("inserthtml",t.stockWrap)}}),a()},render:function(){t.show()}}}(),gift=function(){var t;return{init:function(){t=$("#gift"),gift.shoppingCart.init(),gift.giftList.init(),gift.giftList.render(),gift.giftList.delegate.click=function(t){gift.shoppingCart.update(t)},gift.pay.init()},render:function(){t.show()}}}();gift.giftList=function(){function t(t){t.parent().find(".select").removeClass("select"),t.addClass("select");t.find(".price").data("price");gift.giftList.delegate.click(t)}function e(){i.on("click",".item",function(){t($(this))}),r.click(_.debounce(function(){n($(this))},m,{leading:!0,trailing:!1}))}function n(t){var e=t.data("direction"),n={right:function(){return["-",_.min([d,u])]},left:function(){return["+",_.min([d,f])]}}[e]();o.velocity({left:n[0]+"="+n[1]},{duration:m,complete:function(){({left:function(){f-=n[1],u+=n[1]},right:function(){f+=n[1],u-=n[1]}})[e]();r.filter(".gray").removeClass("gray"),0===f&&c.addClass("gray"),0===u&&l.addClass("gray")}})}var i,o,a,r,c,l,d,u,s,f=0,m=400,p=function(t){$.getJSON("/gift/giftList.htm",function(e){e=_.filter(e,function(t){return"红包"!=t.gift_name||(s=t.gift_id,console.log("红包ID",s),!1)}),t(e.concat(e))})};return{init:function(){i=$("#allGifts"),o=i.find(".gift-item-wrap"),r=i.find(".arrow"),c=i.find(".arrow.left"),l=i.find(".arrow.right"),a=i.find(".gift-item-container"),e()},render:function(){p(function(t){o.append(template("gift-item-template",t)),o.css({width:104*t.length+"px"}),d=a.width(),u=o.width()-a.width()})},delegate:{click:function(){}}}}(),gift.shoppingCart=function(){function t(){var t={pay_source:"0",goodsType:"5",teacherId:room_teacherid,buy_number:l,giftId:c,sum:u},e=Support.getInstance();e.showConfirm(t)}var e,n,i,o,a,r,c,l=1,d=0,u=0,s=function(){a.click(function(){n.text(++l),f()}),o.click(function(){1!==l&&(n.text(--l),f())}),r.click(_.debounce(function(){return ynIsLogin?"1"==ynIsTeacher?void layer.msg("老师不能打赏给老师哦"):0===+u?void layer.msg("多少也给点!"):void t():void yn.login.render()},1500,{leading:!0,trailing:!1}))},f=function(){u=d*l,i.text(u)};return{init:function(){e=$(".gift-send"),n=e.find(".gift-count"),i=e.find(".sum"),o=e.find(".minus"),a=e.find(".plus"),r=e.find(".submit"),s()},update:function(t){d=t.find(".price").data("price"),c=t.data("id"),f()}}}(),gift.pay=function(){var t,e,n=function(){e.click(function(){gift.pay.delegate.click()})};return{init:function(){t=$("#gift-pay"),e=t.find(".circle"),n()},delegate:{click:function(){}}}}();var Support=function(){var t=null,e=function(){function e(){n.find(".close").click(function(){n.hide()}),n.find(".support-short-item").click(function(){$(this).parent().find(".thistype").removeClass("thistype"),$(this).addClass("thistype"),o.val($(this).data("type"))}),n.on("click","#pay-jump",function(){n.hide();var t=new ynmodule.JudgePay;t.init(),t.render()}),n.find(".submit").click(function(e){var n=o.val();if(!/^[1-9][0-9]*$/.test(n))return void layer.msg("客官，真的不能再少了!");var i={pay_source:"0",goodsType:"5",teacherId:c,buy_number:n,giftId:11,sum:n};t.showConfirm(i,"打赏直播")}),n.on("change",".agreement",function(){var t=$(this).get(0).checked;t?(d.show(),$("#pay-jump-button").hide()):(d.hide(),$("#pay-jump-button").show())})}var n,i,o,a,r,c,l,d;return{init:function(t){c=t,n=$("#playtour"),o=$("input#optional"),a=$("#support-surplus"),l=n.find(".confirmPrice"),i=n.find(".getPrice"),yn.centerBox(n),d=$("#pay-jump"),e()},render:function(){o.val(""),n.find(".thistype").removeClass("thistype"),i.show(),l.hide(),n.velocity("transition.expandIn",{duration:300}),yndata.balance().done(function(t){a.html("可用余额<strong id='surplusValue' style='margin:0 5px; color:red;'>"+t.balance+"</strong>牛币"),r=t.balance})},showConfirm:function(t,e){n.show(),i.hide(),l.show(),$("#shouldPayValue").text(t.sum),$("#finalPayValue").text(t.sum),$(".confirmPrice .payName").text(e),$.post("/app/appGiftPayOrder.htm",t,function(t){if("1"==t.status){var e="/html/returnshortcutpayJsp.htm?orderNum="+t.data.orderNum;d.attr("href",e),d.data("link",e)}else layer.msg("参数错误 : "+t.status)},"json")}}};return{getInstance:function(){return t||(t=e()),t}}}(),liveHistory=function(){function t(t){yndata.getMyLiveList({page:r,row:c,userid:o}).done(function(e){t(e)})}function e(t){return _.map(t,function(t){return t._time=t.starttime.match(/^[^\s]+/)[0],t})}var n,i,o,a,r=1,c=15;return{init:function(t){o=t,n=$("#liveHistory"),i=n.find(".items"),a=yn.bootpag(n),a.on("page",function(t,e){r=e,liveHistory.render()})},render:function(){n.show(),t(function(t){console.log("历史直播",t),t.rows=e(t.rows),i.html(template("liveHistory-template",t.rows)),a.bootpag({page:r,total:t.pageNumber})})}}}(),chat=function(){function t(t){yndata.getFriendTalk(n,{page:a,row:r}).done(function(e){t(e)})}function e(){i.on("click",".reply",function(){if(!ynIsLogin)return void yn.login.render();var t=$(this).attr("id"),e=$(this).parents(".item").find(".name").text();talk.setReply(t,{name:e}),$("body").animate({scrollTop:$(document).height()-$(window).height()},500)}),i.on("click",".loadMore",function(){var t=$(this),e=$(this).next(),i={id:e.data("chatid"),periodicalid:n,pageSize:r};$.getJSON("/html/queryInteractionlist.htm",i,function(e){console.log(e),+e.total<1?t.remove():(e.rows=chat.handleData(e.rows).reverse(),t.after(template("friendTalk-template",e.rows)))})}),i.on("click",".audio",function(){$(this).toggleClass("stop"),chat.enableAudio=!chat.enableAudio})}var n,i,o,a=1,r=20,c=!1;return{enableAudio:!0,init:function(t){n=t,i=$("#friendTalk"),o=i.find(".items"),e()},render:function(){t(function(t){return console.log("talk data : ",t),t.hasMore&&o.prepend(ynconfig.more()),t=chat.handleData(t),t&&t.length<1?(o.html(ynconfig.none({margin:250})),void(c=!0)):(o.append(template("friendTalk-template",t)),void o.scrollTop(3e5))})},handleData:function(t){return _.map(t,function(t){return t.replyMark="",t.replyInteraction&&(t.replyMark="@"+t.replyInteraction.nickName+"："),t.nickName==room_nickName?t._isTeacherTalk="true":t._isTeacherTalk="false",t.nickName==$(".username").text()?t.showReply="true":t.showReply="false",t.content=yn.parseFaceCode(t.content),t})},onSocket:function(t){t.ctimeString=t.showTimeStr,t.id=t.dataId,t.content=t.content.replace(/【回复:(.+)】/g,"@$1：");var e=template("friendTalk-template",chat.handleData([t]));c&&(o.find(".nothing").remove(),c=!1),o.append(e),o.scrollTop(3e4),chat.enableAudio&&msn.play()},onTimer:function(){this.getData(function(t){o.html(template("friendTalk-template",t))})}}}(),talk=function(){function t(){a.on("focus",function(){if(!ynIsLogin)return void yn.login.render()}),o.on("click",".close",function(){talk.setReply(-1)}),o.on("click",".face",function(){var t=$(this).offset();return t.top=t.top+25,talk.delegate.clickFace(t),!1}),c.on("click",_.debounce(function(){e()},5e3,{leading:!0,trailing:!1}))}function e(){var t=a.val();if(!t)return void layer.alert("请填写您的交流信息");var e={content:t,prId:i,parentid:d,user_type:ynIsTeacher};$.post("/html/interactionComm.htm",e,function(t){"success"==t?(n(),layer.msg("提交成功")):layer.alert("提交失败")})}function n(){talk.setReply(-1),a.val(""),l.text(200)}var i,o,a,r,c,l,d=-1;return{setReply:function(t,e){e=_.extend({name:""},e),d=t,t==-1?r.hide():r.show(),r.find(".text").text("@"+e.name)},init:function(e){i=e,o=$("#talkWindow"),a=o.find("textarea"),c=o.find(".submit"),r=o.find(".replyInfo"),l=o.find(".wordCount .value"),yn.wordCount(a,{indicate:l}),o.show(),t()},update:function(t){var e=a.val();a.val(e+t)},delegate:{clickFace:function(){}}}}();$(function(){info.init(),menu.init()});var liveDetailSocket=function liveDetailSocket(){try{var webSocket;webSocketPath="ws:"+__ynhost+"/websocket",webSocket=new ReconnectingWebSocket(webSocketPath),webSocket.debug=!0,webSocket.timeoutInterval=5400,window.onbeforeunload=function(){webSocket.close()},webSocket.onopen=function(t){var e="1_"+periodicalid;webSocket.send(e)},webSocket.onmessage=function(event){var _data=eval("("+event.data+")");console.log("push",_data);var dataType=_data.dataType;return"1"==dataType?void living.onSocket(_data):void("2"==dataType&&chat.onSocket(_data))}}catch(e){console.log("use timer update data..."),setInterval(function(){living.onTimer(),chat.onTimer()},2e3)}};